<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>ALiF Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
      /* Base Styles */
      body { margin: 0; font-family: "Inter", system-ui, sans-serif; background: #f9fafb; }

      /* Mobile Bottom Nav */
      .mobile-bottom-nav {
        display: flex; justify-content: space-around; background: #fff;
        border-top: 1px solid #ccc; position: fixed; bottom: 0; width: 100%;
        height: 60px; align-items: center; z-index: 1000;
      }
      .mobile-bottom-nav button {
        background: none; border: none; font-size: 14px; color: #333; flex: 1; cursor: pointer;
      }
      .mobile-bottom-nav button:hover { color: #007bff; font-weight: bold; }

      /* Mass Upload Floating Button */
      #massUploadBtn {
        position: fixed; bottom: 80px; right: 20px;
        background: #007bff; color: white; border: none;
        border-radius: 50px; padding: 12px 20px; font-size: 16px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2); cursor: pointer;
        z-index: 2000; display: flex; align-items: center; gap: 8px;
      }
      #massUploadBtn:hover { background: #0056b3; }

      /* Modal Styles */
      #massUploadModal {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;
      }
      .modal-content {
        background: #fff; padding: 25px; border-radius: 12px; width: 90%; max-width: 400px;
        text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      }
      .modal-content select, .modal-content input {
        width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px;
      }
      .note { font-size: 0.85rem; color: #666; background: #f0f0f0; padding: 8px; border-radius: 4px; margin-bottom: 15px; text-align: left; }
    </style>
  </head>

  <body>
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

    <script>
      (function() {
        if (document.location.hash.indexOf('invite_token') > -1) {
          document.location.pathname = '/admin/';
        }
      })();
    </script>

    <div class="mobile-bottom-nav">
      <button onclick="location.href='#/collections/products'">Products</button>
      <button onclick="location.href='#/collections/services'">Services</button>
      <button onclick="location.href='#/collections/works'">Works</button>
      <button onclick="location.href='#/collections/designs'">Designs</button>
    </div>

    <button id="massUploadBtn">üì¶ Mass Upload</button>

    <div id="massUploadModal">
      <div class="modal-content">
        <h3>üì¶ Mass Upload</h3>
        
        <div class="note">
          <strong>‚ö†Ô∏è Important:</strong>
          <br>1. Upload a <b>CSV</b> file.
          <br>2. Columns must match config (e.g., title, price, image).
          <br>3. <b>Image</b> must be a path (e.g., /uploads/photo.jpg), not the file itself.
        </div>

        <select id="massCollection">
          <option value="products">Products</option>
          <option value="services">Services</option>
          <option value="works">Our Works</option>
          <option value="designs">Designs</option>
        </select>

        <input type="file" id="massFile" accept=".csv" />
        
        <button id="massConfirm" style="width:100%; padding:12px; background:#28a745; color:#fff; border:none; border-radius:6px; cursor:pointer;">Start Upload</button>
        <p id="massUploadStatus" style="margin-top:10px; font-weight:bold;"></p>
        <button id="closeMassModal" style="margin-top:10px; background:transparent; color:#555; border:none; cursor:pointer;">Cancel</button>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const btn = document.getElementById("massUploadBtn");
        const modal = document.getElementById("massUploadModal");
        const closeBtn = document.getElementById("closeMassModal");
        const confirmBtn = document.getElementById("massConfirm");
        const status = document.getElementById("massUploadStatus");

        btn.addEventListener("click", () => modal.style.display = "flex");
        closeBtn.addEventListener("click", () => modal.style.display = "none");

        confirmBtn.addEventListener("click", () => {
          const collection = document.getElementById("massCollection").value;
          const file = document.getElementById("massFile").files[0];

          if (!file) return alert("Please select a CSV file!");
          
          status.textContent = "‚è≥ Reading file...";

          const reader = new FileReader();
          reader.onload = async (e) => {
            const text = e.target.result;
            const rows = text.split("\n").map(row => row.trim()).filter(row => row.length > 0);
            
            if (rows.length < 2) return alert("CSV file is empty or invalid.");

            // Extract headers (keys)
            const headers = rows[0].split(",").map(h => h.trim());
            const totalItems = rows.length - 1;
            
            status.textContent = `üöÄ Uploading ${totalItems} items...`;

            const backend = window.CMS.getBackend();

            let successCount = 0;

            for (let i = 1; i < rows.length; i++) {
              const values = rows[i].split(",");
              
              // Create dynamic object from CSV columns
              let entryObj = {};
              headers.forEach((header, index) => {
                // Handle commas inside quotes if necessary (basic split used here)
                entryObj[header] = values[index] ? values[index].trim() : "";
              });

              // Generate slug from title, or random ID
              const title = entryObj.title || "Untitled " + Date.now();
              const slug = title.toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/^-|-$/g, "");

              // Build YAML Frontmatter dynamically
              let fileContent = "---\n";
              for (const key in entryObj) {
                if (key !== 'description' && key !== 'body') {
                   // Detect numbers
                   const val = entryObj[key];
                   if (!isNaN(val) && val !== "") {
                      fileContent += `${key}: ${val}\n`;
                   } else {
                      fileContent += `${key}: "${val}"\n`;
                   }
                }
              }
              // Add date automatically
              fileContent += `date: "${new Date().toISOString()}"\n`;
              fileContent += "---\n";
              
              // Add description/body
              if (entryObj.description) fileContent += entryObj.description;
              if (entryObj.body) fileContent += entryObj.body;

              try {
                await backend.persistEntry({
                  collection: collection,
                  slug: slug,
                  entry: { path: `${collection}/${slug}.md`, raw: fileContent }
                });
                successCount++;
                status.textContent = `‚úÖ Uploaded ${successCount} of ${totalItems}`;
              } catch (err) {
                console.error(err);
                status.textContent = `‚ùå Error on item ${i}`;
              }
            }
            
            status.textContent = "üéâ All Done! Refreshing...";
            setTimeout(() => location.reload(), 2000);
          };
          
          reader.readAsText(file);
        });
      });
    </script>
  </body>
</html>
