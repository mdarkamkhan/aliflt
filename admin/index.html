<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>ALiF Smart Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <style>
      /* --- 1. RESET & BASE --- */
      body { margin: 0; background: #eff3f6; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
      
      /* --- 2. HIDE DEFAULT CMS SIDEBAR (Mobile View) --- */
      @media (max-width: 768px) {
        .nc-app-sidebar, .nc-sidebar, aside, div[class*="Sidebar"], nav[aria-label="Collections"] { display: none !important; }
        .nc-app-main { width: 100% !important; margin-left: 0 !important; padding-bottom: 80px !important; }
        .nc-app-header { position: sticky !important; top: 0; z-index: 500; }
        .nc-collectionPage-list { display: grid !important; grid-template-columns: 1fr 1fr !important; gap: 10px !important; padding: 10px !important; }
        a.nc-collectionPage-entry { background: white !important; border-radius: 12px !important; box-shadow: 0 2px 6px rgba(0,0,0,0.05) !important; height: auto !important; min-height: 150px !important; }
        .nc-collectionPage-entry-detail { display: none !important; }
      }

      /* --- 3. MOBILE BOTTOM NAV --- */
      .mobile-nav {
        display: none; position: fixed; bottom: 0; left: 0; width: 100%;
        background: white; border-top: 1px solid #eee; height: 65px;
        justify-content: space-around; align-items: center; z-index: 9999;
        padding-bottom: env(safe-area-inset-bottom);
      }
      @media (max-width: 768px) { .mobile-nav { display: flex; } }

      .nav-item { display: flex; flex-direction: column; align-items: center; color: #888; font-size: 11px; flex: 1; padding: 8px 0; cursor: pointer; }
      .nav-item svg { width: 24px; height: 24px; margin-bottom: 4px; fill: currentColor; }
      .nav-item.active { color: #0f62fe; font-weight: 700; }

      /* --- 4. FLOATING ADD BUTTON --- */
      #batchBtn {
        position: fixed; bottom: 85px; right: 20px;
        background: #0f62fe; color: white; border: none;
        width: 56px; height: 56px; border-radius: 50%;
        box-shadow: 0 4px 15px rgba(15, 98, 254, 0.4); cursor: pointer;
        z-index: 9998; display: flex; align-items: center; justify-content: center;
        font-size: 28px; transition: transform 0.2s;
      }
      #batchBtn:active { transform: scale(0.9); }

      /* --- 5. BATCH EDITOR MODAL (MULTI UPLOAD UI) --- */
      #batchModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f4f6f8; z-index: 10000; overflow-y: auto; }
      .batch-header {
        position: sticky; top: 0; background: white; padding: 15px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05); z-index: 100;
        display: flex; justify-content: space-between; align-items: center;
      }
      .batch-container { padding: 15px; padding-bottom: 120px; }
      
      /* PRODUCT CARD STYLE */
      .batch-card {
        background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 1px solid #eee; position: relative;
        transition: all 0.3s ease;
      }
      .batch-card:hover { box-shadow: 0 6px 15px rgba(0,0,0,0.1); }
      .batch-card h4 { margin: 0 0 15px 0; color: #0f62fe; font-size: 18px; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; }
      
      /* FORM INPUTS */
      .form-group { margin-bottom: 15px; }
      .form-group label { display: flex; justify-content: space-between; align-items: center; font-size: 13px; color: #555; margin-bottom: 6px; font-weight: 600; }
      .form-group input, .form-group textarea, .form-group select {
        width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;
        font-size: 15px; background: #fff; box-sizing: border-box; transition: border 0.2s;
      }
      .form-group input:focus, .form-group textarea:focus { border-color: #0f62fe; outline: none; }
      
      /* COPY TO ALL BUTTON */
      .copy-btn {
        background: #e5f0ff; color: #0f62fe; border: none;
        padding: 4px 12px; border-radius: 20px; font-size: 11px; cursor: pointer; font-weight: bold;
        display: flex; align-items: center; gap: 4px;
      }
      .copy-btn:hover { background: #cfe4ff; }

      /* DELETE ROW BUTTON */
      .delete-row {
        position: absolute; top: 15px; right: 15px; color: white; background: #ff4d4d;
        border: none; width: 32px; height: 32px; border-radius: 50%; font-size: 16px; cursor: pointer;
        display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(255, 77, 77, 0.3);
      }

      /* BOTTOM ACTION BUTTONS */
      .fab-add-row {
        position: fixed; bottom: 20px; right: 20px;
        background: #28a745; color: white; padding: 14px 28px;
        border-radius: 30px; border: none; font-weight: bold;
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4); font-size: 16px; z-index: 101; cursor: pointer;
        display: flex; align-items: center; gap: 8px;
      }
      .fab-add-row:active { transform: scale(0.95); }

      .btn-save-all {
        background: #0f62fe; color: white; border: none; padding: 10px 24px;
        border-radius: 8px; font-weight: bold; font-size: 14px; cursor: pointer;
      }
      .btn-save-all:disabled { background: #ccc; cursor: not-allowed; }
      
      /* Helper text */
      .helper { font-size: 11px; color: #999; margin-top: 4px; display: block; font-style: italic; }
    </style>
  </head>

  <body>
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

    <div class="mobile-nav">
      <div class="nav-item active" onclick="navigateTo('products', this)">
        <svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V6h16v12zM6 10h2v2H6zm0 4h2v2H6zm4-4h6v2h-6zm0 4h6v2h-6z"/></svg> Products
      </div>
      <div class="nav-item" onclick="navigateTo('services', this)">
        <svg viewBox="0 0 24 24"><path d="M20.41 4.94l-1.35-1.35c-.78-.78-2.05-.78-2.83 0L13.4 6.41 3 16.82V21h4.18l10.46-10.46 2.77-2.77c.79-.78.79-2.05 0-2.83zm-14 14.12L5 19v-1.36l9.82-9.82 1.41 1.41-9.82 9.83z"/></svg> Services
      </div>
      <div class="nav-item" onclick="navigateTo('designs', this)">
         <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-5.5-2.5l7.51-3.22-7.52-4.28z"/></svg> Designs
      </div>
      <div class="nav-item" onclick="navigateTo('works', this)">
        <svg viewBox="0 0 24 24"><path d="M21 3H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H3V5h18v14zM8 15c0-1.66 1.34-3 3-3 .35 0 .69.07 1 .18V6h5v2h-3v7.03c-.02 1.64-1.35 2.97-3 2.97-1.66 0-3-1.34-3-3z"/></svg> Works
      </div>
    </div>

    <button id="batchBtn" title="Multi Upload">+</button>

    <div id="batchModal">
      <div class="batch-header">
        <button onclick="document.getElementById('batchModal').style.display='none'" style="background:none; border:none; font-size:24px; cursor:pointer;">&larr;</button>
        <h3 style="margin:0; font-size:18px;">Multi Product Upload</h3>
        <button class="btn-save-all" id="saveAllBtn">Save All</button>
      </div>
      
      <div class="batch-container" id="batchList">
        </div>

      <button class="fab-add-row" id="addRowBtn">
        <span style="font-size:20px; line-height:0;">+</span> Add Product
      </button>
    </div>

    <script>
      // --- Standard Navigation Logic ---
      function navigateTo(collection, el) {
        window.location.hash = `#/collections/${collection}`;
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
      }

      document.addEventListener("DOMContentLoaded", function () {
        const batchBtn = document.getElementById("batchBtn");
        const modal = document.getElementById("batchModal");
        const list = document.getElementById("batchList");
        const addRowBtn = document.getElementById("addRowBtn");
        const saveAllBtn = document.getElementById("saveAllBtn");
        let rowCount = 0;

        // Open Modal & Add first row if empty
        batchBtn.addEventListener("click", () => {
          modal.style.display = "block";
          if(rowCount === 0) addNewRow(); 
        });

        // --- HELPER: Create Field HTML ---
        function createField(label, className, type = "text", placeholder = "", canCopy = false) {
          return `
            <div class="form-group">
              <label>
                ${label}
                ${canCopy ? `<button class="copy-btn" onclick="copyToAll('${className}')" title="Copy to all rows below">‚¨áÔ∏è Copy to All</button>` : ''}
              </label>
              ${type === 'textarea' 
                ? `<textarea class="${className}" placeholder="${placeholder}" rows="2"></textarea>` 
                : `<input type="${type}" class="${className}" placeholder="${placeholder}">`
              }
            </div>
          `;
        }

        // --- LOGIC: Add New Row ---
        function addNewRow() {
          rowCount++;
          const div = document.createElement("div");
          div.className = "batch-card";
          div.id = `row-${rowCount}`;
          
          // Only show Copy buttons on the FIRST card
          const sc = (rowCount === 1); 

          div.innerHTML = `
            <h4>Product #${rowCount}</h4>
            <button class="delete-row" onclick="removeRow(this)">‚úï</button>
            
            ${createField("Title (Unique)", "input-title", "text", "e.g. Red Velvet Lace")}
            
            <div class="form-group">
                <label>Image (Select File)</label>
                <input type="file" accept="image/*" onchange="handleFileSelect(this)">
                <input type="text" class="input-image" placeholder="/uploads/filename.jpg" readonly style="background:#f9f9f9; margin-top:5px; color:#666;">
                <span class="helper">Note: Image name auto-fills. Ensure file exists in Media Library.</span>
            </div>

            ${createField("Category", "input-category", "text", "e.g. Lace", sc)}
            ${createField("Price (‚Çπ)", "input-price", "number", "e.g. 500", sc)}
            ${createField("Description", "input-desc", "textarea", "Product details...", sc)}
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                ${createField("Size", "input-size", "text", "e.g. 9m", sc)}
                ${createField("Colour", "input-color", "text", "e.g. Red", sc)}
            </div>
            
            ${createField("Pieces/Meters", "input-pieces", "text", "e.g. 1 Bundle", sc)}
            ${createField("Fabric", "input-fabric", "text", "e.g. Velvet", sc)}
            ${createField("Pattern", "input-pattern", "text", "e.g. Embroidered", sc)}
            ${createField("Ideal For", "input-ideal", "text", "e.g. Saree Border", sc)}
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                ${createField("Del. Charge", "input-del-charge", "text", "e.g. Free", sc)}
                ${createField("Del. Time", "input-del-time", "text", "e.g. 5 Days", sc)}
            </div>
            ${createField("Return Policy", "input-return", "text", "e.g. No Returns", sc)}
          `;
          list.appendChild(div);
          
          // Smooth scroll to new row
          if(rowCount > 1) {
             setTimeout(() => div.scrollIntoView({behavior: "smooth", block: "center"}), 100);
          }
        }

        addRowBtn.addEventListener("click", addNewRow);

        // --- FUNCTION: Remove Row ---
        window.removeRow = function(btn) {
            if(confirm("Delete this product row?")) {
                btn.parentElement.remove();
            }
        }

        // --- FUNCTION: Handle File Selection (Auto-Fill Path) ---
        window.handleFileSelect = function(input) {
            if (input.files && input.files[0]) {
                // We only take the filename because HTML can't upload directly to Git via CMS easily without Widget
                const filename = input.files[0].name;
                const textInput = input.nextElementSibling;
                textInput.value = "/uploads/" + filename;
            }
        }

        // --- FUNCTION: Copy To All ---
        window.copyToAll = function(className) {
          const firstVal = document.querySelector(`.${className}`).value;
          if(!firstVal) {
            alert("First field is empty! Fill it before copying.");
            return;
          }
          const allInputs = document.querySelectorAll(`.${className}`);
          allInputs.forEach(input => input.value = firstVal);
          
          // Little feedback animation
          allInputs.forEach(input => {
              input.style.backgroundColor = "#e6fffa";
              setTimeout(() => input.style.backgroundColor = "#fff", 500);
          });
        };

        // --- FUNCTION: Save All (Persist to Git) ---
        saveAllBtn.addEventListener("click", async () => {
          const cards = document.querySelectorAll(".batch-card");
          if(cards.length === 0) return;

          // Get CMS Backend
          const backend = window.CMS.getBackend();
          if(!backend) {
              alert("CMS not ready! Please login first.");
              return;
          }

          saveAllBtn.textContent = "Saving...";
          saveAllBtn.disabled = true;
          
          let success = 0;
          let errors = 0;

          for (const card of cards) {
            const title = card.querySelector(".input-title").value;
            
            if (!title) {
                card.style.border = "2px solid orange"; // Highlight missing title
                continue; 
            }

            // Gather Data
            const data = {
                title: title,
                image: card.querySelector(".input-image").value,
                price: card.querySelector(".input-price").value,
                category: card.querySelector(".input-category").value,
                description: card.querySelector(".input-desc").value,
                size: card.querySelector(".input-size").value,
                colour: card.querySelector(".input-color").value,
                number_of_pieces: card.querySelector(".input-pieces").value,
                fabric: card.querySelector(".input-fabric").value,
                pattern: card.querySelector(".input-pattern").value,
                ideal_for: card.querySelector(".input-ideal").value,
                delivery_charges: card.querySelector(".input-del-charge").value,
                delivery_within: card.querySelector(".input-del-time").value,
                return_policy: card.querySelector(".input-return").value,
            };

            // Create Slug
            const slug = title.toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/^-|-$/g, "");
            const date = new Date().toISOString();

            // Generate YAML Frontmatter manually
            let fileContent = `---
title: "${title}"
date: "${date}"
layout: "product.liquid"
tags: "product"
permalink: false
`;
            // Add optional fields
            for (const key in data) {
                const val = data[key];
                if(val && key !== 'title') {
                    // If number, don't use quotes
                    if(!isNaN(val) && val.trim() !== "") {
                        fileContent += `${key}: ${val}\n`;
                    } else {
                        // Escape double quotes in strings
                        fileContent += `${key}: "${val.replace(/"/g, '\\"')}"\n`;
                    }
                }
            }
            fileContent += `---`;

            // Upload to Git
            try {
              await backend.persistEntry({
                collection: "products", 
                slug: slug,
                entry: { path: `products/${slug}.md`, raw: fileContent }
              });
              
              success++;
              card.style.border = "2px solid #28a745"; // Green border on success
              card.style.opacity = "0.6";
              card.querySelector(".delete-row").remove(); // Prevent deleting success ones
            } catch (err) {
              console.error(err);
              errors++;
              card.style.border = "2px solid #ff4d4d"; // Red border on fail
              alert(`Failed to save "${title}": ${err.message}`);
            }
          }

          saveAllBtn.textContent = "Save All";
          saveAllBtn.disabled = false;

          if(errors === 0) {
            alert(`All ${success} products uploaded successfully! üéâ`);
            setTimeout(() => location.reload(), 1000);
          } else {
            alert(`${success} Saved, ${errors} Failed. Check red boxes.`);
          }
        });
      });
    </script>
  </body>
</html>
