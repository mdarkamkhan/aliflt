<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>ALiF Smart Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <style>
      /* --- 1. RESET & BASE --- */
      body { margin: 0; background: #eff3f6; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
      
      /* --- 2. HIDE DEFAULT CMS SIDEBAR --- */
      @media (max-width: 768px) {
        .nc-app-sidebar, .nc-sidebar, aside, div[class*="Sidebar"], nav[aria-label="Collections"] { display: none !important; }
        .nc-app-main { width: 100% !important; margin-left: 0 !important; padding-bottom: 80px !important; }
        .nc-app-header { position: sticky !important; top: 0; z-index: 500; }
        .nc-collectionPage-list { display: grid !important; grid-template-columns: 1fr 1fr !important; gap: 10px !important; padding: 10px !important; }
        a.nc-collectionPage-entry { background: white !important; border-radius: 12px !important; box-shadow: 0 2px 6px rgba(0,0,0,0.05) !important; height: auto !important; min-height: 150px !important; }
        .nc-collectionPage-entry-detail { display: none !important; }
      }

      /* --- 3. MOBILE BOTTOM NAV --- */
      .mobile-nav {
        display: none; position: fixed; bottom: 0; left: 0; width: 100%;
        background: white; border-top: 1px solid #eee; height: 65px;
        justify-content: space-around; align-items: center; z-index: 9999;
        padding-bottom: env(safe-area-inset-bottom);
      }
      @media (max-width: 768px) { .mobile-nav { display: flex; } }

      .nav-item { display: flex; flex-direction: column; align-items: center; color: #888; font-size: 11px; flex: 1; padding: 8px 0; cursor: pointer; }
      .nav-item svg { width: 24px; height: 24px; margin-bottom: 4px; fill: currentColor; }
      .nav-item.active { color: #0f62fe; font-weight: 700; }

      /* --- 4. FLOATING ADD BUTTON --- */
      #batchBtn {
        position: fixed; bottom: 85px; right: 20px;
        background: #0f62fe; color: white; border: none;
        width: 56px; height: 56px; border-radius: 50%;
        box-shadow: 0 4px 15px rgba(15, 98, 254, 0.4); cursor: pointer;
        z-index: 9998; display: flex; align-items: center; justify-content: center;
        font-size: 28px; transition: transform 0.2s;
      }
      #batchBtn:active { transform: scale(0.9); }

      /* --- 5. BATCH EDITOR MODAL --- */
      #batchModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f4f6f8; z-index: 10000; overflow-y: auto; }
      .batch-header {
        position: sticky; top: 0; background: white; padding: 15px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05); z-index: 100;
        display: flex; justify-content: space-between; align-items: center;
      }
      .batch-container { padding: 15px; padding-bottom: 120px; }
      
      /* PRODUCT CARD STYLE */
      .batch-card {
        background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #eee; position: relative;
      }
      .batch-card h4 { margin: 0 0 15px 0; color: #0f62fe; font-size: 16px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
      
      .form-group { margin-bottom: 12px; }
      .form-group label { display: flex; justify-content: space-between; align-items: center; font-size: 13px; color: #444; margin-bottom: 5px; font-weight: 600; }
      .form-group input, .form-group textarea, .form-group select {
        width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px;
        font-size: 16px; background: #fff; box-sizing: border-box;
      }
      
      /* COPY BUTTON */
      .copy-btn {
        background: #e5f0ff; color: #0f62fe; border: none;
        padding: 4px 10px; border-radius: 20px; font-size: 11px; cursor: pointer; font-weight: bold;
      }
      .copy-btn:active { background: #cfe4ff; }

      /* DELETE BUTTON */
      .delete-row {
        position: absolute; top: 10px; right: 10px; color: white; background: #ff4d4d;
        border: none; width: 30px; height: 30px; border-radius: 50%; font-size: 14px; cursor: pointer;
        display: flex; align-items: center; justify-content: center;
      }

      /* ACTION BUTTONS */
      .fab-add-row {
        position: fixed; bottom: 20px; right: 20px;
        background: #28a745; color: white; padding: 12px 24px;
        border-radius: 30px; border: none; font-weight: bold;
        box-shadow: 0 4px 10px rgba(40, 167, 69, 0.3); font-size: 16px; z-index: 101;
      }
      .btn-save-all {
        background: #0f62fe; color: white; border: none; padding: 8px 20px;
        border-radius: 8px; font-weight: bold; font-size: 14px;
      }
      
      /* Helper text */
      .helper { font-size: 11px; color: #888; margin-top: 4px; display: block; }
    </style>
  </head>

  <body>
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

    <div class="mobile-nav">
      <div class="nav-item active" onclick="navigateTo('products', this)">
        <svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V6h16v12zM6 10h2v2H6zm0 4h2v2H6zm4-4h6v2h-6zm0 4h6v2h-6z"/></svg> Products
      </div>
      <div class="nav-item" onclick="navigateTo('services', this)">
        <svg viewBox="0 0 24 24"><path d="M20.41 4.94l-1.35-1.35c-.78-.78-2.05-.78-2.83 0L13.4 6.41 3 16.82V21h4.18l10.46-10.46 2.77-2.77c.79-.78.79-2.05 0-2.83zm-14 14.12L5 19v-1.36l9.82-9.82 1.41 1.41-9.82 9.83z"/></svg> Services
      </div>
      <div class="nav-item" onclick="navigateTo('designs', this)">
         <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-5.5-2.5l7.51-3.22-7.52-4.28z"/></svg> Designs
      </div>
      <div class="nav-item" onclick="navigateTo('works', this)">
        <svg viewBox="0 0 24 24"><path d="M21 3H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H3V5h18v14zM8 15c0-1.66 1.34-3 3-3 .35 0 .69.07 1 .18V6h5v2h-3v7.03c-.02 1.64-1.35 2.97-3 2.97-1.66 0-3-1.34-3-3z"/></svg> Works
      </div>
    </div>

    <button id="batchBtn" title="Multi Upload">+</button>

    <div id="batchModal">
      <div class="batch-header">
        <button onclick="document.getElementById('batchModal').style.display='none'" style="background:none; border:none; font-size:24px;">&times;</button>
        <h3 style="margin:0; font-size:18px;">Multi Product Upload</h3>
        <button class="btn-save-all" id="saveAllBtn">Save All</button>
      </div>
      
      <div class="batch-container" id="batchList">
        </div>

      <button class="fab-add-row" id="addRowBtn">+ Add Product</button>
    </div>

    <script>
      function navigateTo(collection, el) {
        window.location.hash = `#/collections/${collection}`;
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
      }

      document.addEventListener("DOMContentLoaded", function () {
        const batchBtn = document.getElementById("batchBtn");
        const modal = document.getElementById("batchModal");
        const list = document.getElementById("batchList");
        const addRowBtn = document.getElementById("addRowBtn");
        const saveAllBtn = document.getElementById("saveAllBtn");
        let rowCount = 0;

        batchBtn.addEventListener("click", () => {
          modal.style.display = "block";
          if(rowCount === 0) addNewRow(); 
        });

        // --- HELPER: Create Input Field Logic ---
        function createField(label, className, type = "text", placeholder = "", canCopy = false) {
          return `
            <div class="form-group">
              <label>
                ${label}
                ${canCopy ? `<button class="copy-btn" onclick="copyToAll('${className}')">⬇️ Copy to All</button>` : ''}
              </label>
              ${type === 'textarea' 
                ? `<textarea class="${className}" placeholder="${placeholder}" rows="2"></textarea>` 
                : `<input type="${type}" class="${className}" placeholder="${placeholder}">`
              }
            </div>
          `;
        }

        // --- ADD NEW ROW FUNCTION ---
        function addNewRow() {
          rowCount++;
          const div = document.createElement("div");
          div.className = "batch-card";
          div.id = `row-${rowCount}`;
          
          // Show Copy buttons ONLY on the first card
          const sc = rowCount === 1; 

          div.innerHTML = `
            <h4>Product #${rowCount}</h4>
            <button class="delete-row" onclick="this.parentElement.remove()">✕</button>
            
            ${createField("Title (Unique)", "input-title", "text", "e.g. Red Velvet Lace")}
            
            <div class="form-group">
                <label>Image (Select from Device)</label>
                <input type="file" accept="image/*" onchange="handleFileSelect(this)">
                <input type="text" class="input-image" placeholder="/uploads/filename.jpg" readonly style="background:#eee; margin-top:5px;">
                <span class="helper">Note: Make sure to upload photos to Media Library first!</span>
            </div>

            ${createField("Category", "input-category", "text", "e.g. Lace", sc)}
            ${createField("Price (₹)", "input-price", "number", "e.g. 500", sc)}
            ${createField("Description", "input-desc", "textarea", "Product details...", sc)}
            
            ${createField("Size", "input-size", "text", "e.g. 9 meter", sc)}
            ${createField("Colour", "input-color", "text", "e.g. Red", sc)}
            ${createField("Pieces/Meters", "input-pieces", "text", "e.g. 1 Bundle", sc)}
            ${createField("Fabric", "input-fabric", "text", "e.g. Velvet", sc)}
            ${createField("Pattern", "input-pattern", "text", "e.g. Embroidered", sc)}
            ${createField("Ideal For", "input-ideal", "text", "e.g. Saree Border", sc)}
            
            ${createField("Delivery Charges", "input-del-charge", "text", "e.g. Free or ₹50", sc)}
            ${createField("Delivery Within", "input-del-time", "text", "e.g. 5-7 Days", sc)}
            ${createField("Payment Type", "input-payment", "text", "e.g. Prepaid/COD", sc)}
            ${createField("Return Policy", "input-return", "text", "e.g. No Returns", sc)}
          `;
          list.appendChild(div);
          
          // Scroll only if it's not the first one
          if(rowCount > 1) div.scrollIntoView({behavior: "smooth"});
        }

        addRowBtn.addEventListener("click", addNewRow);

        // --- FILE HANDLER (Auto-fills the text input) ---
        window.handleFileSelect = function(input) {
            if (input.files && input.files[0]) {
                const filename = input.files[0].name;
                // Find the text input right below this file input
                const textInput = input.nextElementSibling;
                textInput.value = "/uploads/" + filename;
            }
        }

        // --- COPY TO ALL FUNCTION ---
        window.copyToAll = function(className) {
          const firstVal = document.querySelector(`.${className}`).value;
          const allInputs = document.querySelectorAll(`.${className}`);
          allInputs.forEach(input => input.value = firstVal);
          alert(`Copied to ${allInputs.length} items!`);
        };

        // --- SAVE FUNCTION ---
        saveAllBtn.addEventListener("click", async () => {
          const cards = document.querySelectorAll(".batch-card");
          if(cards.length === 0) return;

          saveAllBtn.textContent = "Saving...";
          saveAllBtn.disabled = true;
          
          const backend = window.CMS.getBackend();
          let success = 0;

          for (const card of cards) {
            // Collect Data
            const title = card.querySelector(".input-title").value;
            if (!title) continue; // Skip if no title

            const data = {
                price: card.querySelector(".input-price").value,
                category: card.querySelector(".input-category").value,
                image: card.querySelector(".input-image").value,
                description: card.querySelector(".input-desc").value,
                size: card.querySelector(".input-size").value,
                colour: card.querySelector(".input-color").value,
                number_of_pieces: card.querySelector(".input-pieces").value,
                fabric: card.querySelector(".input-fabric").value,
                work: "", // Optional
                pattern: card.querySelector(".input-pattern").value,
                ideal_for: card.querySelector(".input-ideal").value,
                delivery_charges: card.querySelector(".input-del-charge").value,
                delivery_within: card.querySelector(".input-del-time").value,
                payment_type: card.querySelector(".input-payment").value,
                return_policy: card.querySelector(".input-return").value,
            };

            const slug = title.toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/^-|-$/g, "");
            const date = new Date().toISOString();

            // Build YAML
            let fileContent = `---
title: "${title}"
date: "${date}"
layout: "product.liquid"
tags: "product"
permalink: false
`;
            // Loop through data object
            for (const key in data) {
                const val = data[key];
                if(val) {
                    // Check if number
                    if(!isNaN(val) && val.trim() !== "") {
                        fileContent += `${key}: ${val}\n`;
                    } else {
                        fileContent += `${key}: "${val}"\n`;
                    }
                }
            }
            fileContent += `---`;

            try {
              await backend.persistEntry({
                collection: "products", // Hardcoded for Products Batch
                slug: slug,
                entry: { path: `products/${slug}.md`, raw: fileContent }
              });
              success++;
              card.style.border = "2px solid green";
              card.style.opacity = "0.5";
            } catch (err) {
              console.error(err);
              card.style.border = "2px solid red";
              alert(`Error saving ${title}: ${err.message}`);
            }
          }

          saveAllBtn.textContent = "Done!";
          saveAllBtn.disabled = false;
          alert(`Successfully saved ${success} products!`);
          location.reload();
        });
      });
    </script>
  </body>
</html>
