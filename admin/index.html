<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>ALiF Smart Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <style>
      /* --- 1. RESET & BASE --- */
      body { margin: 0; background: #eff3f6; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
      
      /* --- 2. HIDE DEFAULT CMS SIDEBAR --- */
      @media (max-width: 768px) {
        .nc-app-sidebar, nav[aria-label="Collections"], aside { display: none !important; }
        .nc-app-main { width: 100% !important; margin-left: 0 !important; padding-bottom: 80px !important; }
        .nc-app-header { position: sticky !important; top: 0; z-index: 500; }
        
        /* CARD LIST STYLE */
        .nc-collectionPage-list {
            display: grid !important; grid-template-columns: 1fr 1fr !important; gap: 10px !important; padding: 10px !important;
        }
        a.nc-collectionPage-entry {
            background: white !important; border-radius: 12px !important; box-shadow: 0 2px 6px rgba(0,0,0,0.05) !important;
            height: auto !important; min-height: 150px !important;
        }
        .nc-collectionPage-entry-detail { display: none !important; }
      }

      /* --- 3. MOBILE BOTTOM NAV --- */
      .mobile-nav {
        display: none; position: fixed; bottom: 0; left: 0; width: 100%;
        background: white; border-top: 1px solid #eee; height: 65px;
        justify-content: space-around; align-items: center; z-index: 9999;
        padding-bottom: env(safe-area-inset-bottom);
      }
      @media (max-width: 768px) { .mobile-nav { display: flex; } }

      .nav-item {
        display: flex; flex-direction: column; align-items: center;
        color: #888; font-size: 11px; flex: 1; padding: 8px 0; cursor: pointer;
      }
      .nav-item svg { width: 24px; height: 24px; margin-bottom: 4px; fill: currentColor; }
      .nav-item.active { color: #0f62fe; font-weight: 700; }

      /* --- 4. FLOATING ADD BUTTON --- */
      #batchBtn {
        position: fixed; bottom: 85px; right: 20px;
        background: #0f62fe; color: white; border: none;
        width: 56px; height: 56px; border-radius: 50%;
        box-shadow: 0 4px 15px rgba(15, 98, 254, 0.4); cursor: pointer;
        z-index: 9998; display: flex; align-items: center; justify-content: center;
        font-size: 28px; transition: transform 0.2s;
      }
      #batchBtn:active { transform: scale(0.9); }

      /* --- 5. BATCH EDITOR MODAL --- */
      #batchModal {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #f4f6f8; z-index: 10000; overflow-y: auto;
      }
      .batch-header {
        position: sticky; top: 0; background: white; padding: 15px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05); z-index: 100;
        display: flex; justify-content: space-between; align-items: center;
      }
      .batch-container { padding: 15px; padding-bottom: 100px; }
      
      /* PRODUCT CARD STYLE IN BATCH EDITOR */
      .batch-card {
        background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #eee; position: relative;
      }
      .batch-card h4 { margin: 0 0 10px 0; color: #0f62fe; font-size: 14px; }
      
      .form-group { margin-bottom: 10px; }
      .form-group label { display: block; font-size: 12px; color: #666; margin-bottom: 4px; font-weight: 600; }
      .form-group input, .form-group select {
        width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;
        font-size: 16px; background: #fff; box-sizing: border-box;
      }
      
      /* THE "COPY TO ALL" BUTTON */
      .copy-btn {
        background: #e5f0ff; color: #0f62fe; border: none;
        padding: 4px 8px; border-radius: 4px; font-size: 10px; cursor: pointer;
        float: right; font-weight: bold;
      }
      .copy-btn:active { background: #cfe4ff; }

      /* DELETE BUTTON */
      .delete-row {
        position: absolute; top: 10px; right: 10px; color: red;
        background: none; border: none; font-size: 18px; cursor: pointer;
      }

      /* ACTION BUTTONS */
      .fab-add-row {
        position: fixed; bottom: 20px; right: 20px;
        background: #28a745; color: white; padding: 12px 20px;
        border-radius: 30px; border: none; font-weight: bold;
        box-shadow: 0 4px 10px rgba(40, 167, 69, 0.3); font-size: 16px; z-index: 101;
      }
      .btn-save-all {
        background: #0f62fe; color: white; border: none; padding: 8px 20px;
        border-radius: 8px; font-weight: bold; font-size: 14px;
      }
    </style>
  </head>

  <body>
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

    <div class="mobile-nav">
      <div class="nav-item active" onclick="navigateTo('products', this)">
        <svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V6h16v12zM6 10h2v2H6zm0 4h2v2H6zm4-4h6v2h-6zm0 4h6v2h-6z"/></svg> Products
      </div>
      <div class="nav-item" onclick="navigateTo('services', this)">
        <svg viewBox="0 0 24 24"><path d="M20.41 4.94l-1.35-1.35c-.78-.78-2.05-.78-2.83 0L13.4 6.41 3 16.82V21h4.18l10.46-10.46 2.77-2.77c.79-.78.79-2.05 0-2.83zm-14 14.12L5 19v-1.36l9.82-9.82 1.41 1.41-9.82 9.83z"/></svg> Services
      </div>
      <div class="nav-item" onclick="navigateTo('designs', this)">
         <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-5.5-2.5l7.51-3.22-7.52-4.28z"/></svg> Designs
      </div>
      <div class="nav-item" onclick="navigateTo('works', this)">
        <svg viewBox="0 0 24 24"><path d="M21 3H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H3V5h18v14zM8 15c0-1.66 1.34-3 3-3 .35 0 .69.07 1 .18V6h5v2h-3v7.03c-.02 1.64-1.35 2.97-3 2.97-1.66 0-3-1.34-3-3z"/></svg> Works
      </div>
    </div>

    <button id="batchBtn" title="Batch Upload">+</button>

    <div id="batchModal">
      <div class="batch-header">
        <button onclick="document.getElementById('batchModal').style.display='none'" style="background:none; border:none; font-size:24px;">&times;</button>
        <h3 style="margin:0; font-size:18px;">Batch Upload</h3>
        <button class="btn-save-all" id="saveAllBtn">Save All</button>
      </div>
      
      <div style="padding: 15px; background: #fff; border-bottom: 1px solid #eee;">
        <label style="font-weight:bold; font-size:12px;">Collection:</label>
        <select id="targetCollection" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px; margin-top:5px;">
          <option value="products">Products</option>
          <option value="services">Services</option>
          <option value="designs">Designs</option>
          <option value="works">Works</option>
        </select>
      </div>

      <div class="batch-container" id="batchList">
        </div>

      <button class="fab-add-row" id="addRowBtn">+ Add Row</button>
    </div>

    <script>
      function navigateTo(collection, el) {
        window.location.hash = `#/collections/${collection}`;
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
      }

      document.addEventListener("DOMContentLoaded", function () {
        const batchBtn = document.getElementById("batchBtn");
        const modal = document.getElementById("batchModal");
        const list = document.getElementById("batchList");
        const addRowBtn = document.getElementById("addRowBtn");
        const saveAllBtn = document.getElementById("saveAllBtn");
        let rowCount = 0;

        // Open Modal
        batchBtn.addEventListener("click", () => {
          modal.style.display = "block";
          if(rowCount === 0) addNewRow(); // Add first row automatically
        });

        // ADD NEW ROW FUNCTION
        function addNewRow() {
          rowCount++;
          const div = document.createElement("div");
          div.className = "batch-card";
          div.id = `row-${rowCount}`;
          
          // Only show "Copy ‚¨áÔ∏è" buttons on the FIRST row
          const showCopy = rowCount === 1;

          div.innerHTML = `
            <h4>Item #${rowCount}</h4>
            <button class="delete-row" onclick="this.parentElement.remove()">üóëÔ∏è</button>
            
            <div class="form-group">
              <label>Title</label>
              <input type="text" class="input-title" placeholder="e.g. Red Blouse">
            </div>

            <div class="form-group">
              <label>
                Price 
                ${showCopy ? '<button class="copy-btn" onclick="copyToAll(\'input-price\')">‚¨áÔ∏è Copy to All</button>' : ''}
              </label>
              <input type="number" class="input-price" placeholder="e.g. 500">
            </div>

            <div class="form-group">
              <label>
                Category
                ${showCopy ? '<button class="copy-btn" onclick="copyToAll(\'input-category\')">‚¨áÔ∏è Copy to All</button>' : ''}
              </label>
              <input type="text" class="input-category" placeholder="e.g. lace">
            </div>

            <div class="form-group">
              <label>Image Name (must be in Media Library)</label>
              <input type="text" class="input-image" placeholder="e.g. photo1.jpg">
            </div>
          `;
          list.appendChild(div);
          // Scroll to bottom
          window.scrollTo(0, document.body.scrollHeight);
        }

        addRowBtn.addEventListener("click", addNewRow);

        // COPY TO ALL FUNCTION (Global)
        window.copyToAll = function(className) {
          const firstVal = document.querySelector(`.${className}`).value;
          const allInputs = document.querySelectorAll(`.${className}`);
          allInputs.forEach(input => {
            input.value = firstVal;
          });
          alert(`Copied "${firstVal}" to ${allInputs.length} items!`);
        };

        // SAVE ALL FUNCTION
        saveAllBtn.addEventListener("click", async () => {
          const collection = document.getElementById("targetCollection").value;
          const cards = document.querySelectorAll(".batch-card");
          
          if(cards.length === 0) return;

          saveAllBtn.textContent = "Saving...";
          const backend = window.CMS.getBackend();
          let success = 0;

          for (const card of cards) {
            const title = card.querySelector(".input-title").value;
            const price = card.querySelector(".input-price").value;
            const category = card.querySelector(".input-category").value;
            let image = card.querySelector(".input-image").value;

            if (!title) continue; // Skip empty titles

            // Auto-fix image path
            if (image && !image.startsWith("/uploads/")) {
              image = "/uploads/" + image;
            }

            const slug = title.toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/^-|-$/g, "");
            const date = new Date().toISOString();

            const fileContent = `---
title: "${title}"
date: "${date}"
price: ${price || 0}
category: "${category}"
image: "${image}"
---`;

            try {
              await backend.persistEntry({
                collection: collection,
                slug: slug,
                entry: { path: `${collection}/${slug}.md`, raw: fileContent }
              });
              success++;
              card.style.border = "2px solid green"; // Visual feedback
            } catch (err) {
              console.error(err);
              card.style.border = "2px solid red";
            }
          }

          alert(`Saved ${success} items! Refreshing...`);
          location.reload();
        });
      });
    </script>
  </body>
</html>
