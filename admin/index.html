<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ALiF Admin Panel</title>
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  
  <style>
    /* --- CSS FOR MASS UPLOAD UI --- */
    #mass-upload-ui {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: #f0f2f5; z-index: 10000; overflow-y: auto;
      font-family: sans-serif;
    }

    .mu-header {
      background: #fff; padding: 15px; position: sticky; top: 0; z-index: 100;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex; justify-content: space-between; align-items: center;
    }
    
    #connectionStatus {
        font-size: 12px; font-weight: bold; padding: 5px 10px; border-radius: 4px;
        background: #ffcccc; color: #cc0000; margin-right: 10px; display: inline-block;
    }
    #connectionStatus.ready { background: #ccffcc; color: #006600; }

    #collectionSelector {
        padding: 10px; border: 2px solid #333; border-radius: 6px; font-weight: bold;
    }

    .mu-container { padding: 20px; max-width: 800px; margin: 0 auto; padding-bottom: 100px; }
    
    .mu-card {
        background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative;
    }
    
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; font-size: 12px; font-weight: bold; margin-bottom: 5px; text-transform: uppercase; color: #555; }
    .form-group input, .form-group textarea {
        width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;
        font-size: 14px; box-sizing: border-box;
    }
    
    .btn-copy { float: right; background: #e6f7ff; color: #0050b3; border: none; padding: 4px 8px; cursor: pointer; font-size: 10px; border-radius: 4px; }
    .btn-delete { position: absolute; top: 15px; right: 15px; background: none; border: none; color: red; font-size: 20px; cursor: pointer; }
    
    .fab-container {
        position: fixed; bottom: 20px; right: 20px; display: flex; gap: 10px; z-index: 101;
    }
    .btn-fab {
        background: #000; color: #fff; border: none; padding: 15px 25px; border-radius: 50px;
        font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    .btn-save { background: #006400; }
    .btn-save:disabled { background: #999; cursor: not-allowed; }

    #modeSwitchBtn {
        position: fixed; bottom: 20px; left: 20px; z-index: 9999;
        background: #007bff; color: white; padding: 12px 24px; border-radius: 50px;
        border: 2px solid white; font-weight: bold; cursor: pointer;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>

  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>

  <button id="modeSwitchBtn" onclick="toggleMassMode()">üöÄ Mass Upload</button>

  <div id="mass-upload-ui">
      <div class="mu-header">
          <div>
              <button onclick="toggleMassMode()" style="background:none; border:none; font-size:24px; cursor:pointer;">&larr;</button>
              <span id="connectionStatus">üî¥ Disconnected</span>
          </div>
          <select id="collectionSelector">
              <option value="products">Products</option>
              <option value="services">Services</option>
              <option value="works">Works</option>
              <option value="designs">Designs</option>
              <option value="offers">Banners</option>
          </select>
      </div>

      <div class="mu-container" id="formList"></div>

      <div class="fab-container">
          <button class="btn-fab" onclick="addNewRow()">+ Add</button>
          <button class="btn-fab btn-save" id="saveAllBtn" disabled>Save All</button>
      </div>
  </div>

<script>
    const container = document.getElementById('rows-container');
    const logBox = document.getElementById('logs');
    let rowCount = 0;

    const productCats = ["lace", "latkan", "thread", "aster", "fall", "blouse piece", "plain saten", "plain crape", "plain cotton", "plain reyon", "net", "organza", "jorget", "banarasi", "velvet", "cotton"];
    const serviceCats = ["blouse", "kurti pant", "kurti patyala", "kurti palazzo", "kurti", "garara", "sharara", "gown", "anarkali gown", "frock", "afgani kurti", "lehanga", "trendy lehanga", "saree fall & pico"];

    window.onload = () => {
        document.getElementById('owner').value = localStorage.getItem('gh_owner') || '';
        document.getElementById('repo').value = localStorage.getItem('gh_repo') || '';
        document.getElementById('token').value = localStorage.getItem('gh_token') || '';
        checkConfigInputs();
        // Pehli row automatically add na karein, taaki user bulk select kar sake
        // addRow(); 
    };

    /* =========================================
       1. BULK UPLOAD HANDLER (Magic Feature üì∏)
    ========================================= */
    function handleBulkImages(input) {
        const files = input.files;
        if (files.length === 0) return;

        if (!confirm(`Selected ${files.length} photos. Create ${files.length} new cards?`)) {
            input.value = ''; 
            return;
        }

        // Loop through each selected photo
        Array.from(files).forEach((file) => {
            addRow(); // Nayi row banao
            
            const lastRow = container.lastElementChild;
            const imgPreview = lastRow.querySelector('.img-preview');
            const fileWrapper = lastRow.querySelector('.file-wrapper');
            const fileInput = lastRow.querySelector('.inp-file');
            const titleInput = lastRow.querySelector('.inp-title');

            // 1. File input mein photo set karo (DataTransfer API)
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            fileInput.files = dataTransfer.files;

            // 2. Preview dikhao
            const reader = new FileReader();
            reader.onload = function(e) {
                imgPreview.src = e.target.result;
                imgPreview.style.display = 'block';
                fileWrapper.classList.add('filled');
            };
            reader.readAsDataURL(file);

            // 3. Auto Title (Optional: File name se title banao)
            // let autoTitle = file.name.split('.')[0].replace(/-/g, ' ').replace(/_/g, ' ');
            // titleInput.value = autoTitle;
            // titleInput.classList.add('filled');
        });

        // Scroll to new items
        setTimeout(() => container.lastElementChild.scrollIntoView({ behavior: 'smooth' }), 500);
        input.value = ''; // Reset input to allow selecting same files again
    }

    /* =========================================
       2. HELPER FUNCTIONS
    ========================================= */

    function checkConfigInputs() {
        ['owner', 'repo', 'token'].forEach(id => {
            const el = document.getElementById(id);
            if(el && el.value) el.classList.add('filled');
        });
    }

    document.addEventListener('input', function(e) {
        if(e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
            if(e.target.type !== 'file' && e.target.type !== 'checkbox') {
                e.target.value.trim() !== "" ? e.target.classList.add('filled') : e.target.classList.remove('filled');
            }
        }
    });

    window.previewImage = function(input) {
        const file = input.files[0];
        const wrapper = input.closest('.file-wrapper');
        const img = wrapper.querySelector('.img-preview');
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                img.src = e.target.result;
                img.style.display = 'block';
                wrapper.classList.add('filled');
            }
            reader.readAsDataURL(file);
        } else {
            img.style.display = 'none';
            wrapper.classList.remove('filled');
        }
    }

    window.toggleAd = function(div) {
        const checkbox = div.querySelector('input');
        checkbox.checked = !checkbox.checked;
        if(checkbox.checked) div.classList.add('active');
        else div.classList.remove('active');
    }

    function resetRows() {
        if(rowCount > 0 && !confirm("Change Category? Current rows will be cleared.")) return;
        container.innerHTML = ""; rowCount = 0; addRow();
    }

    function log(msg) {
        logBox.style.display = 'block'; logBox.innerHTML += `<div>> ${msg}</div>`;
    }

    const mkInp = (label, cls, ph, type="text") => `
        <div class="field-group">
            <label>${label} ${rowCount===1 ? `<button class="btn-copy" onclick="copyAll('${cls}')">‚¨á Copy</button>` : ''}</label>
            ${type === 'textarea' ? `<textarea class="${cls}" rows="2" placeholder="${ph}"></textarea>` : `<input type="${type}" class="${cls}" placeholder="${ph}" ${label.includes('Category') ? 'list="cat-list"' : ''}>`}
        </div>`;

    const mkSelect = (label, cls, options) => {
        let opts = options.map(o => `<option value="${o}">${o.toUpperCase()}</option>`).join('');
        return `<div class="field-group"><label>${label} ${rowCount===1 ? `<button class="btn-copy" onclick="copyAll('${cls}')">‚¨á Copy</button>` : ''}</label><select class="${cls}"><option value="">-- Select --</option>${opts}</select></div>`;
    };

    function addRow() {
        rowCount++;
        const div = document.createElement('div');
        div.className = 'card';
        const type = document.getElementById('folder').value;
        
        let html = `
            <div class="card-header"><span class="row-num">#${rowCount}</span><button class="btn-del" onclick="this.parentElement.parentElement.remove()">√ó</button></div>
            
            ${mkInp("Title *", "inp-title", "Item Name")}
            
            <div class="field-group">
                <label>Image *</label>
                <div class="file-wrapper">
                    <input type="file" class="inp-file" accept="image/*" onchange="previewImage(this)">
                    <img class="img-preview">
                </div>
            </div>
            
            <div class="ad-wrapper" onclick="toggleAd(this)">
                <input type="checkbox" class="inp-ad" style="pointer-events:none;">
                <label class="ad-label">üì¢ Mark as Ad</label>
            </div>
            `;

        if (type === 'products') {
            html += `<div class="two-col">${mkInp("Price", "inp-price", "0", "number")}${mkSelect("Category", "inp-cat", productCats)}</div>
            ${mkInp("Description", "inp-desc", "Details...", "textarea")}
            <div class="section-title">Details</div>
            <div class="two-col">${mkInp("Size", "inp-size", "e.g. 9m")}${mkInp("Color", "inp-color", "e.g. Red")}</div>
            <div class="two-col">${mkInp("Pieces/Meter", "inp-pieces", "e.g. 1 Bundle")}${mkInp("Fabric", "inp-fabric", "e.g. Velvet")}</div>
            <div class="two-col">${mkInp("Work", "inp-work", "e.g. Dhaga")}${mkInp("Pattern", "inp-pattern", "e.g. Floral")}</div>
            ${mkInp("Ideal For", "inp-ideal", "e.g. Saree Border")}
            <div class="section-title">Policy</div>
            <div class="two-col">${mkInp("Del. Charges", "inp-del-charge", "Free")}${mkInp("Return Policy", "inp-return", "No Returns")}</div>`;
        } 
        else if (type === 'services' || type === 'works') {
            html += `<div class="two-col">${mkInp("Price", "inp-price", "0", "number")}${mkSelect("Category", "inp-cat", serviceCats)}</div>
            ${mkInp("Description", "inp-desc", "Description...", "textarea")}
            ${ type === 'services' ? mkInp("Service Info", "inp-serv-info", "Extra details...", "textarea") : '' }`;
        } 
        else if (type === 'designs') {
            html += `<div class="two-col">${mkInp("Charges (Price)", "inp-price", "0", "number")}${mkInp("Widely Use For", "inp-cat", "e.g. Blouse")}</div>`;
        }

        div.innerHTML = html;
        container.appendChild(div);
    }

    function copyAll(cls) {
        const val = document.querySelector(`.${cls}`).value;
        if(!val) return alert("Fill this field first!");
        document.querySelectorAll(`.${cls}`).forEach(el => {
            el.value = val; el.classList.add('filled');
        });
    }

    const toBase64 = file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = error => reject(error);
    });

    async function startUpload() {
        const owner = document.getElementById('owner').value.trim();
        const repo = document.getElementById('repo').value.trim();
        const token = document.getElementById('token').value.trim();
        const folder = document.getElementById('folder').value;
        const btn = document.getElementById('uploadBtn');

        if(!owner || !repo || !token) return alert("Fill GitHub Details first!");
        localStorage.setItem('gh_owner', owner); localStorage.setItem('gh_repo', repo); localStorage.setItem('gh_token', token);

        const rows = document.querySelectorAll('.card');
        btn.innerText = "Uploading..."; btn.disabled = true;
        log("Starting upload process...");

        for (const row of rows) {
            const getVal = (c) => row.querySelector(`.${c}`)?.value || "";
            const title = getVal('inp-title');
            const fileInput = row.querySelector('.inp-file');
            const isAd = row.querySelector('.inp-ad').checked;
            
            if(!title) continue;

            const slug = title.toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/^-|-$/g, "");
            const uniqueId = Date.now().toString().slice(-4);
            const finalSlug = `${slug}-${uniqueId}`;
            const date = new Date().toISOString();
            
            let imagePath = "";
            if(fileInput.files.length > 0) {
                const file = fileInput.files[0];
                log(`Uploading Image: ${file.name}...`);
                const uniqueFileName = `${Date.now()}-${file.name.replace(/\s+/g, '-').toLowerCase()}`;
                try {
                    const base64Content = await toBase64(file);
                    const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/uploads/${uniqueFileName}`, {
                        method: 'PUT',
                        headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: `Img: ${title}`, content: base64Content })
                    });
                    if(res.ok) imagePath = `/uploads/${uniqueFileName}`;
                } catch(e) { log(`‚ùå Image Error`); }
            }

            let layout = "product.liquid";
            if(folder === 'designs') layout = "design.liquid";
            if(folder === 'services' || folder === 'works') layout = "service.liquid";

            let content = `---
title: "${title}"
date: "${date}"
layout: "${layout}"
tags: "${folder === 'offers' ? 'offer' : folder.slice(0, -1)}"
image: "${imagePath}"
is_ad: ${isAd}
price: ${getVal('inp-price') || 0}
category: "${getVal('inp-cat')}"
description: "${getVal('inp-desc').replace(/"/g, '\\"')}"
permalink: false
`;
            if(folder === 'products') {
                if(getVal('inp-size')) content += `size: "${getVal('inp-size')}"\n`;
                if(getVal('inp-color')) content += `colour: "${getVal('inp-color')}"\n`;
                if(getVal('inp-pieces')) content += `number_of_pieces: "${getVal('inp-pieces')}"\n`;
                if(getVal('inp-fabric')) content += `fabric: "${getVal('inp-fabric')}"\n`;
                if(getVal('inp-work')) content += `work: "${getVal('inp-work')}"\n`;
                if(getVal('inp-pattern')) content += `pattern: "${getVal('inp-pattern')}"\n`;
                if(getVal('inp-ideal')) content += `ideal_for: "${getVal('inp-ideal')}"\n`;
                if(getVal('inp-del-charge')) content += `delivery_charges: "${getVal('inp-del-charge')}"\n`;
                if(getVal('inp-return')) content += `return_policy: "${getVal('inp-return')}"\n`;
            }
            if(folder === 'services' && getVal('inp-serv-info')) {
                content += `service_information: "${getVal('inp-serv-info').replace(/"/g, '\\"')}"\n`;
            }
            content += `---`;

            const contentEncoded = btoa(unescape(encodeURIComponent(content)));
            try {
                const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${folder}/${finalSlug}.md`, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: `Add ${title}`, content: contentEncoded })
                });
                if(res.ok) {
                    log(`‚úÖ Uploaded: ${title}`);
                    row.style.borderLeft = "5px solid green";
                    row.style.opacity = "0.5";
                } else {
                    log(`‚ùå Error: Check Token`);
                    row.style.borderLeft = "5px solid red";
                }
            } catch(err) { log(`‚ùå Net Error`); }
        }
        
        btn.innerText = "Done! Refresh üîÑ";
        btn.onclick = function() { location.reload(); };
        btn.disabled = false;
        alert("Upload Complete!");
    }
</script>
</body>
</html>
