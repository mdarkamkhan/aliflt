<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>ALiF Smart Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <style>
      /* --- 1. RESET & BASE --- */
      body { margin: 0; background: #eff3f6; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
      
      /* --- 2. HIDE DEFAULT SIDEBAR --- */
      @media (max-width: 768px) {
        .nc-app-sidebar, .nc-sidebar, aside { display: none !important; }
        .nc-app-main { width: 100% !important; margin-left: 0 !important; padding-bottom: 80px !important; }
        .nc-app-header { position: sticky !important; top: 0; z-index: 500; }
      }

      /* --- 3. MOBILE NAV --- */
      .mobile-nav {
        display: none; position: fixed; bottom: 0; left: 0; width: 100%;
        background: white; border-top: 1px solid #eee; height: 65px;
        justify-content: space-around; align-items: center; z-index: 9999;
        padding-bottom: env(safe-area-inset-bottom);
      }
      @media (max-width: 768px) { .mobile-nav { display: flex; } }

      .nav-item { display: flex; flex-direction: column; align-items: center; color: #888; font-size: 11px; flex: 1; padding: 8px 0; cursor: pointer; }
      .nav-item svg { width: 24px; height: 24px; margin-bottom: 4px; fill: currentColor; }
      .nav-item.active { color: #0f62fe; font-weight: 700; }

      /* --- 4. FLOATING BUTTON --- */
      #batchBtn {
        position: fixed; bottom: 85px; right: 20px;
        background: #0f62fe; color: white; border: none;
        width: 60px; height: 60px; border-radius: 50%;
        box-shadow: 0 4px 20px rgba(15, 98, 254, 0.5); cursor: pointer;
        z-index: 100000; display: flex; align-items: center; justify-content: center;
        font-size: 32px; transition: transform 0.2s;
      }
      #batchBtn:active { transform: scale(0.9); }

      /* --- 5. MODAL --- */
      #batchModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f4f6f8; z-index: 100001; overflow-y: auto; }
      
      .batch-header {
        position: sticky; top: 0; background: white; padding: 15px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05); z-index: 100;
        display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap;
      }

      #collectionSelector {
        padding: 10px; border: 2px solid #0f62fe; border-radius: 6px;
        font-size: 14px; font-weight: bold; color: #0f62fe; background: #fff;
        flex-grow: 1; max-width: 220px; cursor: pointer;
      }

      .batch-container { padding: 15px; padding-bottom: 120px; }
      
      .batch-card {
        background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 1px solid #eee; position: relative;
        transition: all 0.3s ease;
      }
      .batch-card h4 { margin: 0 0 15px 0; color: #0f62fe; font-size: 18px; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; display:flex; justify-content:space-between; }
      
      .form-group { margin-bottom: 15px; }
      .form-group label { display: flex; justify-content: space-between; align-items: center; font-size: 13px; color: #555; margin-bottom: 6px; font-weight: 600; }
      .form-group input, .form-group textarea, .form-group select {
        width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;
        font-size: 15px; background: #fff; box-sizing: border-box;
      }
      .form-group input:focus { border-color: #0f62fe; outline: none; }
      
      .copy-btn {
        background: #e5f0ff; color: #0f62fe; border: none;
        padding: 4px 12px; border-radius: 20px; font-size: 11px; cursor: pointer; font-weight: bold;
      }

      .delete-row {
        color: #ff4d4d; background: none; border: none; cursor: pointer; font-size: 18px; font-weight:bold;
      }

      .fab-add-row {
        position: fixed; bottom: 20px; right: 20px;
        background: #28a745; color: white; padding: 14px 28px;
        border-radius: 30px; border: none; font-weight: bold;
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4); font-size: 16px; z-index: 101; cursor: pointer;
      }

      .btn-save-all {
        background: #0f62fe; color: white; border: none; padding: 10px 20px;
        border-radius: 8px; font-weight: bold; font-size: 14px; cursor: pointer;
      }
      
      .helper { font-size: 11px; color: #999; margin-top: 4px; display: block; }
    </style>
  </head>

  <body>
    <script src="https://unpkg.com/netlify-cms@^2.10.192/dist/netlify-cms.js"></script>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

    <div class="mobile-nav">
      <div class="nav-item" onclick="navigateTo('products', this)">üõçÔ∏è Products</div>
      <div class="nav-item" onclick="navigateTo('services', this)">‚úÇÔ∏è Services</div>
      <div class="nav-item" onclick="navigateTo('designs', this)">üé® Designs</div>
      <div class="nav-item" onclick="navigateTo('offers', this)">üì¢ Banners</div>
    </div>

    <button id="batchBtn" title="Bulk Upload Tool">+</button>

    <div id="batchModal">
      <div class="batch-header">
        <button onclick="document.getElementById('batchModal').style.display='none'" style="font-size:24px; border:none; background:none; cursor:pointer;">&larr;</button>
        
        <select id="collectionSelector">
            <option value="products">üõçÔ∏è Products</option>
            <option value="services">‚úÇÔ∏è Services</option>
            <option value="works">üëó Works</option>
            <option value="designs">üé® Designs</option>
            <option value="offers">üì¢ Banners (Offers)</option>
        </select>

        <button class="btn-save-all" id="saveAllBtn">Save All</button>
      </div>
      
      <div class="batch-container" id="batchList"></div>
      <button class="fab-add-row" id="addRowBtn">+ Add More</button>
    </div>

    <script>
      function navigateTo(collection, el) {
        window.location.hash = `#/collections/${collection}`;
      }

      document.addEventListener("DOMContentLoaded", function () {
        const batchBtn = document.getElementById("batchBtn");
        const modal = document.getElementById("batchModal");
        const list = document.getElementById("batchList");
        const addRowBtn = document.getElementById("addRowBtn");
        const saveAllBtn = document.getElementById("saveAllBtn");
        const collectionSelector = document.getElementById("collectionSelector");
        let rowCount = 0;

        batchBtn.addEventListener("click", () => {
          modal.style.display = "block";
          if(rowCount === 0) addNewRow(); 
        });

        const collectionConfig = {
            products: { tag: 'product', layout: 'product.liquid' },
            services: { tag: 'service', layout: 'service.liquid' },
            works:    { tag: 'work',    layout: 'service.liquid' },
            designs:  { tag: 'design',  layout: 'design.liquid' },
            offers:   { tag: 'offer',   layout: 'product.liquid' }
        };

        function createField(label, className, type = "text", placeholder = "", canCopy = false) {
          return `
            <div class="form-group">
              <label>
                ${label}
                ${canCopy ? `<button class="copy-btn" onclick="copyToAll('${className}')">‚¨áÔ∏è Copy to All</button>` : ''}
              </label>
              ${type === 'textarea' 
                ? `<textarea class="${className}" placeholder="${placeholder}" rows="2"></textarea>` 
                : `<input type="${type}" class="${className}" placeholder="${placeholder}">`
              }
            </div>
          `;
        }

        function addNewRow() {
          rowCount++;
          const div = document.createElement("div");
          div.className = "batch-card";
          div.id = `row-${rowCount}`;
          const sc = (rowCount === 1); 
          const type = collectionSelector.value;
          let fieldsHTML = "";

          fieldsHTML += `<h4>#${rowCount} <button class="delete-row" onclick="removeRow(this)">‚úï</button></h4>`;
          fieldsHTML += createField("Title (Required)", "input-title", "text", "Item Name");
          
          fieldsHTML += `
            <div class="form-group">
                <label>Image (Select File)</label>
                <input type="file" accept="image/*" onchange="handleFileSelect(this)">
                <input type="text" class="input-image" placeholder="/uploads/..." readonly style="background:#f9f9f9; margin-top:5px; color:#666;">
            </div>`;

          if(type !== 'offers') {
              fieldsHTML += createField("Category", "input-category", "text", "", sc);
              fieldsHTML += createField("Price (‚Çπ)", "input-price", "number", "0", sc);
              fieldsHTML += createField("Description", "input-desc", "textarea", "", sc);
          }

          if(type === 'products') {
              fieldsHTML += `<div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                ${createField("Size", "input-size", "text", "", sc)}
                ${createField("Colour", "input-color", "text", "", sc)}
              </div>
              ${createField("Fabric", "input-fabric", "text", "", sc)}
              ${createField("Ideal For", "input-ideal", "text", "", sc)}`;
          }

          div.innerHTML = fieldsHTML;
          list.appendChild(div);
          if(rowCount > 1) setTimeout(() => div.scrollIntoView({behavior: "smooth", block: "center"}), 100);
        }

        addRowBtn.addEventListener("click", addNewRow);

        collectionSelector.addEventListener("change", () => {
            list.innerHTML = ""; rowCount = 0; addNewRow();
        });

        window.removeRow = function(btn) {
            if(confirm("Delete this row?")) btn.parentElement.parentElement.remove();
        }

        window.handleFileSelect = function(input) {
            if (input.files && input.files[0]) {
                const filename = input.files[0].name;
                input.nextElementSibling.value = "/uploads/" + filename;
            }
        }

        window.copyToAll = function(className) {
          const firstVal = document.querySelector(`.${className}`).value;
          if(!firstVal) { alert("First field is empty!"); return; }
          document.querySelectorAll(`.${className}`).forEach(input => {
              input.value = firstVal;
          });
        };

        // --- FIXED SAVE LOGIC (DIRECT ACCESS) ---
        saveAllBtn.addEventListener("click", async () => {
          const cards = document.querySelectorAll(".batch-card");
          if(cards.length === 0) return;

          // DIRECT BACKEND ACCESS (STABLE)
          const backend = window.CMS.getBackend();
          if(!backend) {
              alert("‚ö†Ô∏è Authentication Error: Please refresh the page and login again.");
              return;
          }

          const selectedType = collectionSelector.value;
          const config = collectionConfig[selectedType];

          saveAllBtn.textContent = "Saving...";
          saveAllBtn.disabled = true;
          
          let success = 0;
          let errors = 0;

          for (const card of cards) {
            const title = card.querySelector(".input-title").value;
            if (!title) { card.style.border = "2px solid orange"; continue; }

            const getVal = (cls) => {
                const el = card.querySelector(`.${cls}`);
                return el ? el.value : "";
            };

            const data = {
                title: title,
                image: getVal("input-image"),
                price: getVal("input-price"),
                category: getVal("input-category"),
                description: getVal("input-desc"),
                size: getVal("input-size"),
                colour: getVal("input-color"),
                fabric: getVal("input-fabric"),
                ideal_for: getVal("input-ideal"),
            };

            const slug = title.toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/^-|-$/g, "");
            const date = new Date().toISOString();

            let fileContent = `---
title: "${title}"
date: "${date}"
layout: "${config.layout}" 
tags: "${config.tag}"
permalink: false
`;
            for (const key in data) {
                const val = data[key];
                if(val) {
                    if(!isNaN(val) && val.trim() !== "") {
                        fileContent += `${key}: ${val}\n`;
                    } else {
                        fileContent += `${key}: "${val.replace(/"/g, '\\"')}"\n`;
                    }
                }
            }
            fileContent += `---`;

            try {
              // DIRECT API CALL TO CMS
              await backend.persistEntry({
                collection: selectedType, 
                slug: slug,
                entry: { path: `${selectedType}/${slug}.md`, raw: fileContent }
              });
              success++;
              card.style.border = "2px solid #28a745";
              card.style.opacity = "0.5";
            } catch (err) {
              console.error(err);
              errors++;
              card.style.border = "2px solid #ff4d4d";
            }
          }

          saveAllBtn.textContent = "Save All";
          saveAllBtn.disabled = false;

          if(errors === 0) {
            alert(`‚úÖ Saved ${success} items successfully!`);
            setTimeout(() => location.reload(), 500);
          } else {
            alert(`${success} Saved, ${errors} Failed. Check connection.`);
          }
        });
      });
    </script>
  </body>
</html>
