<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ALiF Admin Panel</title>
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  
  <style>
    /* --- STYLE FOR MASS UPLOAD UI (Hidden by default) --- */
    #mass-upload-ui {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: #f0f2f5; z-index: 10000; overflow-y: auto;
      font-family: sans-serif;
    }

    .mu-header {
      background: #fff; padding: 15px; position: sticky; top: 0; z-index: 100;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: flex; justify-content: space-between; align-items: center;
    }
    
    #connectionStatus {
        font-size: 12px; font-weight: bold; padding: 5px 10px; border-radius: 4px;
        background: #ffcccc; color: #cc0000; margin-right: 10px; display: inline-block;
    }
    #connectionStatus.ready { background: #ccffcc; color: #006600; }

    #collectionSelector {
        padding: 10px; border: 2px solid #333; border-radius: 6px; font-weight: bold;
    }

    .mu-container { padding: 20px; max-width: 800px; margin: 0 auto; padding-bottom: 100px; }
    
    .mu-card {
        background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative;
    }
    
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; font-size: 12px; font-weight: bold; margin-bottom: 5px; text-transform: uppercase; color: #555; }
    .form-group input, .form-group textarea {
        width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;
        font-size: 14px; box-sizing: border-box;
    }
    
    .btn-copy { float: right; background: #e6f7ff; color: #0050b3; border: none; padding: 4px 8px; cursor: pointer; font-size: 10px; border-radius: 4px; }
    .btn-delete { position: absolute; top: 15px; right: 15px; background: none; border: none; color: red; font-size: 20px; cursor: pointer; }
    
    .fab-container {
        position: fixed; bottom: 20px; right: 20px; display: flex; gap: 10px; z-index: 101;
    }
    .btn-fab {
        background: #000; color: #fff; border: none; padding: 15px 25px; border-radius: 50px;
        font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    .btn-save { background: #006400; }
    .btn-save:disabled { background: #999; cursor: not-allowed; }

    /* 2. TOGGLE BUTTON STYLE (Visible on Standard CMS) */
    #modeSwitchBtn {
        position: fixed; bottom: 20px; left: 20px; z-index: 9999;
        background: #007bff; color: white; padding: 12px 24px; border-radius: 50px;
        border: 2px solid white; font-weight: bold; cursor: pointer;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>

  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>

  <button id="modeSwitchBtn" onclick="toggleMassMode()">ðŸš€ Mass Upload</button>

  <div id="mass-upload-ui">
      <div class="mu-header">
          <div>
              <button onclick="toggleMassMode()" style="background:none; border:none; font-size:24px; cursor:pointer;">&larr;</button>
              <span id="connectionStatus">ðŸ”´ Disconnected</span>
          </div>
          <select id="collectionSelector">
              <option value="products">Products</option>
              <option value="services">Services</option>
              <option value="works">Works</option>
              <option value="designs">Designs</option>
              <option value="offers">Banners</option>
          </select>
      </div>

      <div class="mu-container" id="formList"></div>

      <div class="fab-container">
          <button class="btn-fab" onclick="addNewRow()">+ Add</button>
          <button class="btn-fab btn-save" id="saveAllBtn" disabled>Save All</button>
      </div>
  </div>

  <script>
    // --- Connection Logic ---
    let cmsBackend = null;
    
    function checkConnection() {
        const statusEl = document.getElementById('connectionStatus');
        const saveBtn = document.getElementById('saveAllBtn');
        
        try {
            // Yeh line check karti hai ki normal CMS connect hua ya nahi
            cmsBackend = window.CMS.getBackend();
            if(cmsBackend) {
                statusEl.textContent = "ðŸŸ¢ Connected";
                statusEl.className = "ready";
                saveBtn.disabled = false;
            } else {
                statusEl.textContent = "ðŸ”´ Connecting...";
                statusEl.className = "";
                saveBtn.disabled = true;
            }
        } catch(e) {
            console.log("Waiting for CMS...");
        }
    }
    // Har 1 second mein check karo
    setInterval(checkConnection, 1000);

    // --- Toggle Logic ---
    function toggleMassMode() {
        const ui = document.getElementById('mass-upload-ui');
        const btn = document.getElementById('modeSwitchBtn');
        const cmsRoot = document.getElementById('nc-root'); // Standard CMS div

        if (ui.style.display === 'none' || ui.style.display === '') {
            // Mass Mode ON
            ui.style.display = 'block';
            btn.style.display = 'none';
            if(cmsRoot) cmsRoot.style.display = 'none';
            if(document.querySelectorAll('.mu-card').length === 0) addNewRow();
        } else {
            // Normal Mode ON
            ui.style.display = 'none';
            btn.style.display = 'block';
            if(cmsRoot) cmsRoot.style.display = 'block';
        }
    }

    // --- Form Logic ---
    const list = document.getElementById('formList');
    const selector = document.getElementById('collectionSelector');
    let rowCount = 0;

    const configs = {
        products: { layout: 'product.liquid', tag: 'product' },
        services: { layout: 'service.liquid', tag: 'service' },
        works:    { layout: 'service.liquid', tag: 'work' },
        designs:  { layout: 'design.liquid',  tag: 'design' },
        offers:   { layout: 'product.liquid', tag: 'offer' }
    };

    selector.addEventListener('change', () => {
        if(confirm("Change Category? Current list will be cleared.")) {
            list.innerHTML = ""; rowCount = 0; addNewRow();
        }
    });

    function createInp(label, cls, ph, type="text", showCopy=false) {
        return `
        <div class="form-group">
            <label>${label} ${showCopy ? `<button class="btn-copy" onclick="copyToAll('${cls}')">â¬‡ Copy to All</button>` : ''}</label>
            ${type === 'textarea' 
                ? `<textarea class="${cls}" placeholder="${ph}" rows="2"></textarea>` 
                : `<input type="${type}" class="${cls}" placeholder="${ph}">` }
        </div>`;
    }

    function addNewRow() {
        rowCount++;
        const div = document.createElement('div');
        div.className = 'mu-card';
        const isFirst = rowCount === 1;
        const type = selector.value;

        let html = `<h4>Item #${rowCount} <button class="btn-delete" onclick="this.parentElement.parentElement.remove()">Ã—</button></h4>
        ${createInp("Title *", "inp-title", "Name")}
        
        <div class="form-group">
            <label>Image (Select File) *</label>
            <input type="file" accept="image/*" onchange="this.nextElementSibling.value = '/uploads/' + this.files[0].name">
            <input type="text" class="inp-image" readonly style="background:#eee; margin-top:5px;" placeholder="/uploads/...">
        </div>
        ${ selector.value !== 'offers' ? 
            createInp("Category", "inp-cat", "e.g. Lace", "text", isFirst) +
            createInp("Price (Number)", "inp-price", "0", "number", isFirst) +
            createInp("Description", "inp-desc", "Details...", "textarea", isFirst)
        : ''}
        ${ selector.value === 'products' ? 
            `<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">${createInp("Size", "inp-size", "9m", "text", isFirst)}${createInp("Color", "inp-color", "Red", "text", isFirst)}</div>` +
            createInp("Fabric", "inp-fab", "Velvet", "text", isFirst)
        : ''}
        `;
        list.appendChild(div);
        div.scrollIntoView({behavior:'smooth'});
    }

    window.copyToAll = function(cls) {
        const val = document.querySelector(`.${cls}`).value;
        document.querySelectorAll(`.${cls}`).forEach(el => el.value = val);
    }

    // --- Save Logic ---
    document.getElementById('saveAllBtn').addEventListener('click', async () => {
        const btn = document.getElementById('saveAllBtn');
        const type = selector.value;
        
        btn.textContent = "Uploading...";
        btn.disabled = true;
        let success = 0;

        const cards = document.querySelectorAll('.mu-card');
        for (const card of cards) {
            const getVal = (c) => card.querySelector(`.${c}`)?.value || "";
            const title = getVal('inp-title');
            if(!title) continue;

            // Unique Slug Logic
            const cleanTitle = title.toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/^-|-$/g, "");
            const uniqueId = Date.now().toString().slice(-4);
            const slug = `${cleanTitle}-${uniqueId}`;
            const date = new Date().toISOString();
            
            let content = `---
title: "${title}"
date: "${date}"
layout: "${configs[type].layout}"
tags: "${configs[type].tag}"
permalink: false
`;
            const fields = {
                image: getVal('inp-image'), price: getVal('inp-price'),
                category: getVal('inp-cat'), description: getVal('inp-desc'),
                size: getVal('inp-size'), colour: getVal('inp-color'), fabric: getVal('inp-fab')
            };

            for(let k in fields) {
                if(fields[k]) {
                    content += `${k}: ${isNaN(fields[k]) ? `"${fields[k]}"` : fields[k]}\n`;
                }
            }
            content += `---`;

            try {
                await cmsBackend.persistEntry({
                    collection: type,
                    slug: slug,
                    entry: { path: `${type}/${slug}.md`, raw: content }
                });
                success++;
                card.style.border = "2px solid green";
            } catch(e) {
                console.error(e);
                card.style.border = "2px solid red";
            }
        }

        btn.textContent = "Save All";
        btn.disabled = false;
        
        if(success > 0) {
            alert(`âœ… Successfully uploaded ${success} items!`);
            location.reload();
        }
    });
  </script>
</body>
</html>
