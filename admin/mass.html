<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALiF Ultimate Uploader (Multi-Angle)</title>
    <style>
        /* --- STYLING --- */
        body { font-family: sans-serif; padding: 15px; background: #f0f2f5; padding-bottom: 120px; }
        h2 { text-align: center; color: #333; margin-top: 0; }
        
        .config-box { background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-left: 5px solid #007bff; }
        .config-row { display: flex; flex-direction: column; gap: 10px; margin-bottom: 10px; }
        label { font-size: 12px; font-weight: bold; color: #555; text-transform: uppercase; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 15px; box-sizing: border-box; background: #fff; }
        input:focus, textarea:focus, select:focus { border-color: #007bff; outline: none; }

        /* FILLED STATE */
        .filled { border: 2px solid #28a745 !important; background-color: #e8f5e9 !important; }

        /* CARD STYLE */
        .card { background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 5px solid #333; position: relative; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .card-header { display: flex; justify-content: space-between; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .row-num { font-weight: bold; font-size: 1.1em; color: #007bff; }
        .btn-del { color: red; font-weight: bold; background: none; border: none; font-size: 24px; padding: 0 10px; cursor: pointer; }

        .field-group { margin-bottom: 12px; }
        .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        /* IMAGE WRAPPERS */
        .file-wrapper { background: #eef; padding: 10px; border-radius: 5px; border: 1px dashed #007bff; text-align: center; margin-top: 5px; transition: all 0.3s ease; position: relative; }
        .file-wrapper.filled { border: 2px solid #28a745; background-color: #e8f5e9; }
        .img-preview { display: none; width: 100px; height: 100px; object-fit: cover; border-radius: 5px; margin: 10px auto 0 auto; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        /* EXTRA ANGLES STYLE */
        .gallery-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .extra-img-box { width: 80px; position: relative; }
        .extra-file-wrapper { width: 80px; height: 80px; border: 1px dashed #999; display: flex; align-items: center; justify-content: center; background: #f9f9f9; border-radius: 5px; overflow: hidden; cursor: pointer; }
        .extra-file-wrapper img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .btn-remove-angle { position: absolute; top: -5px; right: -5px; background: red; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; cursor: pointer; display: none; }
        .btn-add-angle { background: #333; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 12px; cursor: pointer; margin-top: 5px; }

        /* AD CHECKBOX STYLE */
        .ad-wrapper { display: flex; align-items: center; gap: 10px; background: #f9f9f9; padding: 10px; border-radius: 5px; border: 1px solid #ddd; cursor: pointer; margin-bottom: 15px; margin-top: 15px; }
        .ad-wrapper.active { background: #fff3cd; border-color: #ffc107; }
        .ad-checkbox { width: 20px; height: 20px; margin: 0; cursor: pointer; }
        .ad-label { margin: 0; cursor: pointer; color: #856404; font-size: 14px; }

        /* BUTTONS */
        .fab-container { position: fixed; bottom: 20px; right: 20px; display: flex; gap: 10px; z-index: 100; }
        .btn { padding: 14px 24px; border: none; border-radius: 50px; font-weight: bold; color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.3); cursor: pointer; font-size: 16px; }
        .btn-add { background: #333; }
        .btn-upload { background: #006400; }
        .btn-copy { background: #e6f7ff; color: #0050b3; border: none; padding: 4px 8px; border-radius: 4px; font-size: 11px; float: right; cursor: pointer; }
        
        #logs { background: #000; color: #0f0; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 12px; margin-top: 20px; display: none; white-space: pre-wrap; }
    </style>
</head>
<body>

    <h2>üöÄ Ultimate Uploader (Multi-Angle)</h2>
    
    <div class="config-box">
        <div class="config-row">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div><label>GitHub User</label><input type="text" id="owner"></div>
                <div><label>Repo Name</label><input type="text" id="repo"></div>
            </div>
            <div><label>Token</label><input type="password" id="token"></div>
            <div>
                <label>Upload To:</label>
                <select id="folder" onchange="resetRows()">
                    <option value="products">üõçÔ∏è Products</option>
                    <option value="services">‚úÇÔ∏è Services</option>
                    <option value="works">üëó Works</option>
                    <option value="designs">üé® Designs</option>
                    <option value="offers">üì¢ Offers Banner</option>
                </select>
            </div>
        </div>
    </div>

    <div style="text-align: center; margin: 20px 0;">
        <input type="file" id="bulkInput" multiple accept="image/*" style="display: none;" onchange="handleBulkImages(this)">
        <button onclick="document.getElementById('bulkInput').click()" style="background: linear-gradient(135deg, #007bff, #6610f2); color: white; border: none; padding: 12px 30px; border-radius: 50px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2);">
            üì∏ Select Multiple Photos
        </button>
    </div>

    <div id="rows-container"></div>

    <div class="fab-container">
        <button class="btn btn-add" onclick="addRow()">+ Add</button>
        <button class="btn btn-upload" id="uploadBtn" onclick="startUpload()">Upload üöÄ</button>
    </div>

    <div id="logs"></div>

    <datalist id="cat-list">
        <option value="lace"><option value="latkan"><option value="blouse piece"><option value="velvet"><option value="organza"><option value="cotton">
    </datalist>

    <script>
        // --- GLOBAL VARIABLES ---
        const container = document.getElementById('rows-container');
        const logBox = document.getElementById('logs');
        let rowCount = 0;

        const productCats = ["lace", "latkan", "thread", "aster", "fall", "blouse piece", "plain saten", "plain crape", "plain cotton", "plain reyon", "net", "organza", "jorget", "banarasi", "velvet", "cotton"];
        const serviceCats = ["blouse", "kurti pant", "kurti patyala", "kurti palazzo", "kurti", "garara", "sharara", "gown", "anarkali gown", "frock", "afgani kurti", "lehanga", "trendy lehanga", "saree fall & pico"];

        // --- ON LOAD ---
        window.onload = () => {
            document.getElementById('owner').value = localStorage.getItem('gh_owner') || '';
            document.getElementById('repo').value = localStorage.getItem('gh_repo') || '';
            document.getElementById('token').value = localStorage.getItem('gh_token') || '';
            checkConfigInputs();
        };

        // --- BULK IMAGE HANDLER ---
        window.handleBulkImages = function(input) {
            const files = input.files;
            if (files.length === 0) return;

            if (!confirm(`Selected ${files.length} photos. Create ${files.length} new cards?`)) {
                input.value = ''; 
                return;
            }

            Array.from(files).forEach((file) => {
                addRow();
                const lastRow = container.lastElementChild;
                const imgPreview = lastRow.querySelector('.main-preview');
                const fileWrapper = lastRow.querySelector('.file-wrapper');
                const fileInput = lastRow.querySelector('.inp-file');

                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                fileInput.files = dataTransfer.files;

                const reader = new FileReader();
                reader.onload = function(e) {
                    imgPreview.src = e.target.result;
                    imgPreview.style.display = 'block';
                    fileWrapper.classList.add('filled');
                };
                reader.readAsDataURL(file);
            });

            setTimeout(() => {
                window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
            }, 300);
            input.value = '';
        };

        // --- ADD ROW FUNCTION ---
        window.addRow = function() {
            rowCount++;
            const div = document.createElement('div');
            div.className = 'card';
            const type = document.getElementById('folder').value;
            
            let html = `
                <div class="card-header"><span class="row-num">#${rowCount}</span><button class="btn-del" onclick="this.parentElement.parentElement.remove()">√ó</button></div>
                
                ${mkInp("Title *", "inp-title", "Item Name")}
                
                <div class="field-group">
                    <label>Main Image *</label>
                    <div class="file-wrapper">
                        <input type="file" class="inp-file" accept="image/*" onchange="previewImage(this)">
                        <img class="img-preview main-preview">
                    </div>
                </div>

                <div class="field-group">
                    <label>Other Angles (Gallery)</label>
                    <div class="gallery-container"></div>
                    <button class="btn-add-angle" onclick="addExtraAngle(this)">+ Add Angle</button>
                </div>
                
                <div class="ad-wrapper" onclick="toggleAd(this)">
                    <input type="checkbox" class="inp-ad" style="pointer-events:none;">
                    <label class="ad-label">üì¢ Mark as Ad</label>
                </div>
                `;

            if (type === 'products') {
                html += `<div class="two-col">${mkInp("Price", "inp-price", "0", "number")}${mkSelect("Category", "inp-cat", productCats)}</div>
                ${mkInp("Description", "inp-desc", "Details...", "textarea")}
                <div class="section-title">Details</div>
                <div class="two-col">${mkInp("Size", "inp-size", "e.g. 9m")}${mkInp("Color", "inp-color", "e.g. Red")}</div>
                <div class="two-col">${mkInp("Pieces/Meter", "inp-pieces", "e.g. 1 Bundle")}${mkInp("Fabric", "inp-fabric", "e.g. Velvet")}</div>
                <div class="two-col">${mkInp("Work", "inp-work", "e.g. Dhaga")}${mkInp("Pattern", "inp-pattern", "e.g. Floral")}</div>
                ${mkInp("Ideal For", "inp-ideal", "e.g. Saree Border")}
                <div class="section-title">Policy</div>
                <div class="two-col">${mkInp("Del. Charges", "inp-del-charge", "Free")}${mkInp("Return Policy", "inp-return", "No Returns")}</div>`;
            } 
            else if (type === 'services' || type === 'works') {
                html += `<div class="two-col">${mkInp("Price", "inp-price", "0", "number")}${mkSelect("Category", "inp-cat", serviceCats)}</div>
                ${mkInp("Description", "inp-desc", "Description...", "textarea")}
                ${ type === 'services' ? mkInp("Service Info", "inp-serv-info", "Extra details...", "textarea") : '' }`;
            } 
            else if (type === 'designs') {
                html += `<div class="two-col">${mkInp("Charges (Price)", "inp-price", "0", "number")}${mkInp("Widely Use For", "inp-cat", "e.g. Blouse")}</div>`;
            }

            div.innerHTML = html;
            container.appendChild(div);
        };

        // --- NEW: ADD EXTRA ANGLE ---
        window.addExtraAngle = function(btn) {
            const container = btn.previousElementSibling;
            const div = document.createElement('div');
            div.className = 'extra-img-box';
            div.innerHTML = `
                <div class="extra-file-wrapper" onclick="this.querySelector('input').click()">
                    <span style="font-size:20px; color:#ccc;">+</span>
                    <img class="extra-preview">
                    <input type="file" class="inp-extra-file" accept="image/*" style="display:none;" onchange="previewExtra(this)">
                </div>
                <button class="btn-remove-angle" onclick="this.parentElement.remove()">√ó</button>
            `;
            container.appendChild(div);
        }

        window.previewExtra = function(input) {
            const file = input.files[0];
            const wrapper = input.parentElement;
            const img = wrapper.querySelector('img');
            const span = wrapper.querySelector('span');
            const removeBtn = wrapper.nextElementSibling;
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    img.src = e.target.result;
                    img.style.display = 'block';
                    span.style.display = 'none';
                    removeBtn.style.display = 'block';
                    wrapper.style.border = '2px solid #28a745';
                }
                reader.readAsDataURL(file);
            }
        }

        // --- HELPER FUNCTIONS ---
        function checkConfigInputs() {
            ['owner', 'repo', 'token'].forEach(id => {
                const el = document.getElementById(id);
                if(el && el.value) el.classList.add('filled');
            });
        }

        document.addEventListener('input', function(e) {
            if(e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                if(e.target.type !== 'file' && e.target.type !== 'checkbox') {
                    e.target.value.trim() !== "" ? e.target.classList.add('filled') : e.target.classList.remove('filled');
                }
            }
        });

        window.previewImage = function(input) {
            const file = input.files[0];
            const wrapper = input.closest('.file-wrapper');
            const img = wrapper.querySelector('.img-preview');
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    img.src = e.target.result;
                    img.style.display = 'block';
                    wrapper.classList.add('filled');
                }
                reader.readAsDataURL(file);
            } else {
                img.style.display = 'none';
                wrapper.classList.remove('filled');
            }
        };

        window.toggleAd = function(div) {
            const checkbox = div.querySelector('input');
            checkbox.checked = !checkbox.checked;
            if(checkbox.checked) div.classList.add('active');
            else div.classList.remove('active');
        };

        window.resetRows = function() {
            if(rowCount > 0 && !confirm("Change Category? Current rows will be cleared.")) return;
            container.innerHTML = ""; rowCount = 0; addRow();
        };

        function log(msg) {
            logBox.style.display = 'block'; logBox.innerHTML += `<div>> ${msg}</div>`;
        }

        const mkInp = (label, cls, ph, type="text") => `
            <div class="field-group">
                <label>${label} ${rowCount===1 ? `<button class="btn-copy" onclick="copyAll('${cls}')">‚¨á Copy</button>` : ''}</label>
                ${type === 'textarea' ? `<textarea class="${cls}" rows="2" placeholder="${ph}"></textarea>` : `<input type="${type}" class="${cls}" placeholder="${ph}" ${label.includes('Category') ? 'list="cat-list"' : ''}>`}
            </div>`;

        const mkSelect = (label, cls, options) => {
            let opts = options.map(o => `<option value="${o}">${o.toUpperCase()}</option>`).join('');
            return `<div class="field-group"><label>${label} ${rowCount===1 ? `<button class="btn-copy" onclick="copyAll('${cls}')">‚¨á Copy</button>` : ''}</label><select class="${cls}"><option value="">-- Select --</option>${opts}</select></div>`;
        };

        window.copyAll = function(cls) {
            const val = document.querySelector(`.${cls}`).value;
            if(!val) return alert("Fill this field first!");
            document.querySelectorAll(`.${cls}`).forEach(el => {
                el.value = val; el.classList.add('filled');
            });
        };

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = error => reject(error);
        });

        window.startUpload = async function() {
            const owner = document.getElementById('owner').value.trim();
            const repo = document.getElementById('repo').value.trim();
            const token = document.getElementById('token').value.trim();
            const folder = document.getElementById('folder').value;
            const btn = document.getElementById('uploadBtn');

            if(!owner || !repo || !token) return alert("Fill GitHub Details first!");
            localStorage.setItem('gh_owner', owner); localStorage.setItem('gh_repo', repo); localStorage.setItem('gh_token', token);

            const rows = document.querySelectorAll('.card');
            if(rows.length === 0) return alert("No items to upload!");

            btn.innerText = "Uploading..."; btn.disabled = true;
            log("Starting upload process...");

            for (const row of rows) {
                const getVal = (c) => row.querySelector(`.${c}`)?.value || "";
                const title = getVal('inp-title');
                const fileInput = row.querySelector('.inp-file');
                const isAd = row.querySelector('.inp-ad').checked;
                
                if(!title) continue;

                const slug = title.toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/^-|-$/g, "");
                const uniqueId = Date.now().toString().slice(-4);
                const finalSlug = `${slug}-${uniqueId}`;
                const date = new Date().toISOString();
                
                // 1. MAIN IMAGE UPLOAD
                let imagePath = "";
                if(fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    log(`Uploading Main: ${file.name}...`);
                    const uniqueFileName = `${Date.now()}-${file.name.replace(/\s+/g, '-').toLowerCase()}`;
                    try {
                        const base64Content = await toBase64(file);
                        const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/uploads/${uniqueFileName}`, {
                            method: 'PUT',
                            headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify({ message: `Img: ${title}`, content: base64Content })
                        });
                        if(res.ok) imagePath = `/uploads/${uniqueFileName}`;
                    } catch(e) { log(`‚ùå Image Error`); }
                }

                // 2. EXTRA ANGLES UPLOAD (New Loop)
                let galleryPaths = [];
                const extraInputs = row.querySelectorAll('.inp-extra-file');
                for (let i = 0; i < extraInputs.length; i++) {
                    if(extraInputs[i].files.
                       log(`Uploading Angle ${i+1}...`);
                        const exName = `${Date.now()}-extra-${i}-${exFile.name.replace(/\s+/g, '-').toLowerCase()}`;
                        try {
                            const exBase64 = await toBase64(exFile);
                            const exRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/uploads/${exName}`, {
                                method: 'PUT',
                                headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                                body: JSON.stringify({ message: `Gallery: ${title}`, content: exBase64 })
                            });
                            if(exRes.ok) galleryPaths.push(`/uploads/${exName}`);
                        } catch(e) { log(`‚ùå Extra Img Error`); }
                    }
                }

                let layout = "product.liquid";
                if(folder === 'designs') layout = "design.liquid";
                if(folder === 'services' || folder === 'works') layout = "service.liquid";

                // 3. CONSTRUCT YAML
                let content = `---
title: "${title}"
date: "${date}"
layout: "${layout}"
tags: "${folder === 'offers' ? 'offer' : folder.slice(0, -1)}"
image: "${imagePath}"
gallery: ${JSON.stringify(galleryPaths)}
is_ad: ${isAd}
price: ${getVal('inp-price') || 0}
category: "${getVal('inp-cat')}"
description: "${getVal('inp-desc').replace(/"/g, '\\"')}"
permalink: false
`;
                if(folder === 'products') {
                    if(getVal('inp-size')) content += `size: "${getVal('inp-size')}"\n`;
                    if(getVal('inp-color')) content += `colour: "${getVal('inp-color')}"\n`;
                    if(getVal('inp-pieces')) content += `number_of_pieces: "${getVal('inp-pieces')}"\n`;
                    if(getVal('inp-fabric')) content += `fabric: "${getVal('inp-fabric')}"\n`;
                    if(getVal('inp-work')) content += `work: "${getVal('inp-work')}"\n`;
                    if(getVal('inp-pattern')) content += `pattern: "${getVal('inp-pattern')}"\n`;
                    if(getVal('inp-ideal')) content += `ideal_for: "${getVal('inp-ideal')}"\n`;
                    if(getVal('inp-del-charge')) content += `delivery_charges: "${getVal('inp-del-charge')}"\n`;
                    if(getVal('inp-return')) content += `return_policy: "${getVal('inp-return')}"\n`;
                }
                if(folder === 'services' && getVal('inp-serv-info')) {
                    content += `service_information: "${getVal('inp-serv-info').replace(/"/g, '\\"')}"\n`;
                }
                content += `---`;

                const contentEncoded = btoa(unescape(encodeURIComponent(content)));
                try {
                    const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${folder}/${finalSlug}.md`, {
                        method: 'PUT',
                        headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: `Add ${title}`, content: contentEncoded })
                    });
                    if(res.ok) {
                        log(`‚úÖ Uploaded: ${title}`);
                        row.style.borderLeft = "5px solid green";
                        row.style.opacity = "0.5";
                    } else {
                        log(`‚ùå Error: Check Token`);
                        row.style.borderLeft = "5px solid red";
                    }
                } catch(err) { log(`‚ùå Net Error`); }
            }
            
            btn.innerText = "Done! Refresh üîÑ";
            btn.style.backgroundColor = "#333";
            btn.onclick = function() { location.reload(); };
            btn.disabled = false;
            alert("Upload Complete!");
        };
    </script>
</body>
</html>
